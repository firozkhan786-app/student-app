let students = [];
let editIndex = -1;
let studentsChart, incomeChart;

function login(){
    const pass=document.getElementById("pass").value;

    fetch("/login",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({password:pass})
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.success){
            document.getElementById("loginBox").style.display="none";
            document.getElementById("app").style.display="block";
            loadStudents();
        }else{
            alert("Wrong password");
        }
    });
}

function loadStudents(){
    fetch("/students")
    .then(res=>res.json())
    .then(data=>{
        students=data;
        renderList();
    });
}

function addStudent(){
    const student={
        name:name.value,
        phone:phone.value,
        country:country.value,
        fees:Number(fees.value),
        status:status.value,
        notes:notes.value,
        date:new Date().toISOString().split("T")[0]
    };

    if(editIndex!==-1){
        fetch("/students/"+editIndex,{
            method:"PUT",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(student)
        }).then(()=>{
            editIndex=-1;
            clearForm();
            loadStudents();
        });
        return;
    }

    fetch("/students",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(student)
    }).then(()=>{
        clearForm();
        loadStudents();
    });
}

function editStudent(i){
    const s=students[i];
    name.value=s.name;
    phone.value=s.phone;
    country.value=s.country;
    fees.value=s.fees;
    status.value=s.status;
    notes.value=s.notes;
    editIndex=i;
    window.scrollTo({top:0,behavior:"smooth"});
}

function deleteStudent(i){
    fetch("/students/"+i,{method:"DELETE"})
    .then(()=>loadStudents());
}

function clearForm(){
    name.value="";
    phone.value="";
    country.value="";
    fees.value="";
    status.selectedIndex=0;
    notes.value="";
    name.focus();
}

function statusColor(s){
    if(s==="New Lead") return "#ffc107";
    if(s==="Contacted") return "#0dcaf0";
    if(s==="Documents Pending") return "#fd7e14";
    if(s==="Applied") return "#6f42c1";
    if(s==="Visa Approved") return "#198754";
    if(s==="Rejected") return "#dc3545";
    return "#999";
}

function statusProgress(s){
    const map={
        "New Lead":10,
        "Contacted":25,
        "Documents Pending":40,
        "Applied":60,
        "Visa Approved":100,
        "Rejected":100
    };
    return map[s]||0;
}
function renderCards(){
    const box=document.getElementById("cards");

    let total=students.length;
    let newLeads=0, applied=0, approved=0, revenue=0;

    students.forEach(s=>{
        if(s.status==="New Lead") newLeads++;
        if(s.status==="Applied") applied++;
        if(s.status==="Visa Approved") approved++;
        revenue+=Number(s.fees||0);
    });

    box.innerHTML=`
    <div style="background:white;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);min-width:150px;">
        <b>Total Students</b><br><span style="font-size:22px">${total}</span>
    </div>

    <div style="background:white;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);min-width:150px;">
        <b>New Leads</b><br><span style="font-size:22px">${newLeads}</span>
    </div>

    <div style="background:white;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);min-width:150px;">
        <b>Applied</b><br><span style="font-size:22px">${applied}</span>
    </div>

    <div style="background:white;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);min-width:150px;">
        <b>Visa Approved</b><br><span style="font-size:22px">${approved}</span>
    </div>

    <div style="background:white;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);min-width:150px;">
        <b>Total Revenue</b><br><span style="font-size:22px">â‚¹${revenue}</span>
    </div>
    `;
}
function renderList(){
    const ul=list;
    const searchText=search.value.toLowerCase();

    ul.innerHTML="";
    renderCards();
    let totalFees=0;

    students.forEach((s,i)=>{
        const text=(s.name+s.phone+s.country+s.status+s.notes).toLowerCase();

        if(text.includes(searchText)){
            totalFees+=s.fees||0;

            const li=document.createElement("li");

            li.innerHTML=`
            <div>
                <b>${s.name}</b> <span style="color:#888;font-size:12px">(${s.id||""})</span><br>
                ğŸ“ <a href="https://wa.me/${s.phone}" target="_blank">${s.phone}</a><br>
                ğŸŒ ${s.country}<br>
                ğŸ’° â‚¹${s.fees}<br>

                <span style="background:${statusColor(s.status)};color:white;padding:3px 8px;border-radius:6px;">
                    ${s.status}
                </span><br>

                ğŸ—’ ${s.notes}<br>
                ğŸ“… ${s.date}<br>

                <div style="background:#eee;height:6px;border-radius:5px;margin-top:6px;">
                  <div style="width:${statusProgress(s.status)}%;background:${statusColor(s.status)};height:6px;border-radius:5px;"></div>
                </div>
            </div>

            <div>
                <button onclick="editStudent(${i})">Edit</button>
                <button onclick="deleteStudent(${i})">Delete</button>
            </div>
            `;

            ul.appendChild(li);
        }
    });

    total.innerText="Total Students: "+students.length;
    income.innerText="Total Fees: â‚¹"+totalFees;

    drawCharts();
}

function drawCharts(){
    const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    let stu=new Array(12).fill(0);
    let inc=new Array(12).fill(0);

    students.forEach(s=>{
        if(!s.date) return;
        const m=new Date(s.date).getMonth();
        stu[m]++;
        inc[m]+=Number(s.fees||0);
    });

    if(studentsChart) studentsChart.destroy();
    if(incomeChart) incomeChart.destroy();

    studentsChart=new Chart(document.getElementById("studentsChart"),{
        type:"bar",
        data:{labels:months,datasets:[{label:"Students",data:stu}]}
    });

    incomeChart=new Chart(document.getElementById("incomeChart"),{
        type:"line",
        data:{labels:months,datasets:[{label:"Income",data:inc}]}
    });
}

function exportCSV(){
    let csv="Name,Phone,Country,Fees,Status,Notes,Date\n";
    students.forEach(s=>{
        csv+=`${s.name},${s.phone},${s.country},${s.fees},${s.status},${s.notes},${s.date}\n`;
    });
    const blob=new Blob([csv],{type:"text/csv"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="students.csv";
    a.click();
}